---
- name: Check CPU and RAM utilization and trigger Email
  hosts: web-server
  become: yes
  vars:
   - gmail_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39613666343434633833346265633034313633663764326462333532386133383233363635386531
          3934653830393331613434313464383335656332643437350a353334616565636131373662306639
          37336334363430353263323638323863633264656238353931393732646635353832326165343937
          3662616233323435650a323466396166313035616162343465333966376338633262353638343563
  tasks:
  - name: Transfer executable shellscript
    copy:
      src: /home/devops/shellscripts/metrics.sh
      dest: /opt/metrics.sh
      mode: 0775
  
  - name: Execute shellscript
    ansible.builtin.shell: /opt/metrics.sh >>> /home/devops/shellscripts/metric-log.txt
    args:
      executable: /bin/bash
  
  - mail:
      host: smtp.gmail.com
      port: 587
      subtype: html
      username: kadurunarendra@gmail.com
      password: "{{ gmail_password }}"
      to: lharish609@gmail.com
      from: kadurunarendra@gmail.com
      attach: /home/devops/shellscripts/metric-log.txt
      subject: Ansible-report for monitoring CPU and Memory Usage
      body: 'Monitoring has been successfully provisioned.'
    delegate_to: localhost