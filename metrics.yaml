---
- name: Check CPU and RAM utilization and trigger Email
  hosts: web-server
  become: yes
  vars:
   - gmail_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36653064323135636132636532323735356632363364333962663764613736383235333864376232
          6435326136626135376364646538336636323362346636660a643963343265616137363132393830
          30653937623165633164303934636531346530383664323066643866376133643266613330623631
          3331626163303265300a363166343065363965393066626130313238316233653966303735613566
  tasks:
  - name: Transfer executable shellscript
    copy:
      src: /home/devops/shellscripts/metrics.sh
      dest: /opt/metrics.sh
      mode: 0775
  
  - name: Execute shellscript
    ansible.builtin.shell: /opt/metrics.sh >> /home/devops/shellscripts/metric-log.txt
    args:
      executable: /bin/bash
  
  - mail:
      host: smtp.gmail.com
      port: 587
      subtype: html
      username: kadurunarendra@gmail.com
      password: "{{ gmail_password }}"
      to: lharish609@gmail.com
      from: kadurunarendra@gmail.com
      attach: /home/devops/shellscripts/metric-log.txt
      subject: Ansible-report for monitoring CPU and Memory Usage
      body: 'Monitoring has been successfully provisioned.'
    delegate_to: 172.31.90.46