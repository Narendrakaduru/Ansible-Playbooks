---
- name: Check CPU and RAM utilization and trigger Email
  hosts: web-server
  become: yes
  vars:
    - gmail-password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62343864363639383565346237313735323162396234383132613139623231316565306565346661
          3931366365306638323134313865663537643536373238340a343864333836306330663061346361
          38636339333831613633303162653264643537353730326461623332323230643433636132623330
          6461386563313164320a333061343534656630633033373739643835646431623730643830323333
          32646132613965653931623432383161326336333864643063343930656666383966d
  tasks:
  - name: Transfer executable shellscript
    copy:
      src: /home/devops/shellscripts/metrics.sh
      dest: /opt/metrics.sh
      mode: 0775
  
  - name: Execute shellscript
    ansible.builtin.shell: /opt/metrics.sh >>> /home/devops/shellscripts/metric-log.txt
    args:
      executable: /bin/bash
  
  - mail:
      host: smtp.gmail.com
      port: 587
      subtype: html
      username: kadurunarendra@gmail.com
      password: "{{ gmail-password }}"
      to: lharish609@gmail.com
      from: kadurunarendra@gmail.com
      attach: /home/devops/shellscripts/metric-log.txt
      subject: Ansible-report for monitoring CPU and Memory Usage
      body: 'Monitoring has been successfully provisioned.'
    delegate_to: localhost