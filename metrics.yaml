---
- name: Check CPU and RAM utilization and trigger Email
  hosts: web-server
  become: yes
  vars:
    - gmail_password.txt: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        66633165666138386534636430393566636531653036316166303734313534623232386465393531
        3639363463373532653633326466396634353762623362660a343334356234383931356161353533
        39623734616537653364333636383165623930616634633631336564633362653166623764316132
        3739376163646239340a373261346566356337653065663030613831653537666233356632373065
  tasks:
  - name: Transfer executable shellscript
    copy:
      src: /home/devops/shellscripts/metrics.sh
      dest: /opt/metrics.sh
      mode: 0775
  
  - name: Execute shellscript
    ansible.builtin.shell: /opt/metrics.sh >> /home/devops/shellscripts/metric-log.txt
    args:
      executable: /bin/bash
  
  - mail:
      host: smtp.gmail.com
      port: 587
      subtype: html
      username: kadurunarendra@gmail.com
      password: "{{ zgzzsoienoxignqd }}"
      to: lharish609@gmail.com
      from: kadurunarendra@gmail.com
      attach: /home/devops/shellscripts/metric-log.txt
      subject: Ansible-report for monitoring CPU and Memory Usage
      body: 'Monitoring has been successfully provisioned.'
    delegate_to: 172.31.90.46